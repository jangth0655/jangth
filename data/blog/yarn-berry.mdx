---
title: 'yarn berry ì ìš©í•´ë³´ìž'
date: '2024-04-01'
tags: ['ci-cd']
draft: false
summary: 'yarn berryì— ëŒ€í•´ ì•Œì•„ë³´ê³  docker fileì„ ì—…ë°ì´íŠ¸ í•´ë³´ìž'
---

## Yarn berry

yarn classic(v1)ì€ nodejs ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì˜ì¡´ì„±ê´€ë¦¬ë¥¼ í•˜ëŠ” ê²ƒìœ¼ë¡œ ë„ë¦¬ ì‚¬ìš© ë˜ì–´ ì™”ëŠ”ë°ìš”, ì´í›„ v2ë¶€í„°ëŠ” yarn berryë¥¼ ì˜ë¯¸í•˜í•©ë‹ˆë‹¤.

- yarn classicì€ v1
- yarn berryëŠ” v2, v3, v4

### ðŸ¤”Â node_modulesì˜ ë¬¸ì œì 

`node_modules` ì‚¬ìš©í•˜ëŠ” ì „í†µì ì¸ nodejs ì˜ì¡´ì„± ê´€ë¦¬ ë°©ì‹ì€ ë„ë¦¬ ì‚¬ìš©ë˜ì—ˆì§€ë§Œ ë¬¸ì œì ì´ ìžˆì—ˆëŠ”ë°ìš”,

- **ì¤‘ì²©ëœ êµ¬ì¡°ì™€ ì´ì— ë”°ë¥¸ ìƒë‹¹ížˆ ì»¤ì§€ëŠ” íŒŒì¼ í¬ê¸°**

`node_modules`ëŠ” ì¤‘ì²©ëœ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìžˆìœ¼ë©° ë”°ë¼ì„œ ì—¬ëŸ¬ ë²„ì „ì˜ ê°™ì€ íŒ¨í‚¤ì§€ê°€ ë™ì‹œì— ì¡´ìž¬í•  ê°€ëŠ¥ì„±ì´ ìžˆë‹¤ê³  í•©ë‹ˆë‹¤. ì´ëŠ” ì˜ì¡´ì„± ìžì²´ë¥¼ ë³µìž¡í•˜ê²Œ ë§Œë“¤ê±°ë‚˜ í˜¸í™˜ì„± ë¬¸ì œë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìžˆê³  ë””ìŠ¤í¬ ê³µê°„ì„ ë§Žì´ ì°¨ì§€í•˜ê²Œ ë©ë‹ˆë‹¤.

- **ë¹„íš¨ìš¸ì ì¸ ì˜ì¡´ì„± ê²€ìƒ‰**

`node_modules`ëŠ” íŒŒì¼ì„ íƒìƒ‰í•  ë•Œ require í•¨ìˆ˜ë¡œ íƒìƒ‰ì„ í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ require í•¨ìˆ˜ë¡œ íƒìƒ‰í•˜ëŠ” ê²½ìš° ëª¨ë“ˆì„ ë¡œë“œí•  ë•Œ `node_modules` í´ë”ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ íƒìƒ‰í•˜ì—¬ í•„ìš”í•œ íŒŒì¼ì„ ì°¾ê²Œë˜ëŠ”ë° ì´ëŠ” ë””ìŠ¤í¬ I/Oê°€ ìƒë‹¹ížˆ ë§Žì´ ë°œìƒí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

`npx create nextjs` ë¥¼ í–ˆì„ ê²½ìš° ë¡œì»¬í™˜ê²½ì—ì„œ `node_modules`ì™€ `yarn berry`ì˜ zipíŒŒì¼ì˜ ìš©ëŸ‰ì„ ë¹„êµí•´ë³´ì•˜ìŠµë‹ˆë‹¤. ë§Œì•½ ì„¤ì¹˜ëœ í”„ë¡œì íŠ¸ íŒ¨í‚¤ì§€ê°€ ì»¤ì§ˆìˆ˜ë¡ ìš©ëŸ‰ ì°¨ì´ê°€ ë§Žì„ ê²ƒìœ¼ë¡œ ìƒê°ë©ë‹ˆë‹¤.

```
### yarn classic
du -sh node_modules
315M    node_modules

### yarn berry
du -sh .yarn/cache
307M    .yarn/
```

## PnP (Plugâ€™nPlay)

ìœ„ì™€ ê°™ì€ ë¬¸ì œì ìœ¼ë¡œ ì¸í•´ `yarn berry` ë¶€í„°ëŠ” `PnP` ì „ëžµì´ ë“±ìž¥í–ˆìŠµë‹ˆë‹¤.

`yarn berry`ì˜ `PnP`ì „ëžµì€ `node_modules`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  `.yarn` ê²½ë¡œ í•˜ìœ„ì— `.zip`íŒŒì¼ë¡œ ì••ì¶•í•˜ì—¬ ì €ìž¥í•©ë‹ˆë‹¤.

ì´ì™€ ê°™ì´ zipíŒŒì¼ í˜•íƒœë¡œ íŒ¨í‚¤ì§€ë¥¼ ì €ìž¥í•˜ê²Œë˜ë©´ **ì••ì¶•í•˜ì—¬ ì €ìž¥**í•˜ê¸° ë•Œë¬¸ì— ì¤‘ë³µëœ íŒ¨í‚¤ì§€ë¥¼ ì—¬ëŸ¬ ë³µì‚¬ë³¸ìœ¼ë¡œ ì €ìž¥í•˜ëŠ” ê²ƒë³´ë‹¤ íš¨ìœ¨ì ì´ë©°, ì••ì¶•í•˜ì—¬ ì €ìž¥ í•˜ê¸° ë•Œë¬¸ì— **ë””ìŠ¤í¬ ìš©ëŸ‰ ìžì²´ê°€ ì¤„ì–´ë“ ë‹¤**ëŠ” ìž¥ì ì´ ìžˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  ìžë™ìœ¼ë¡œ ìƒì„±ëœ `.pnp.cjs`íŒŒì¼ì´ `.zip`íŒŒì¼ì„ ì°¸ì¡°í•˜ì—¬ ì˜ì¡´ì„± ì •ë³´ë¥¼ ì •í™•í•˜ê²Œ ë§µí•‘í•˜ì—¬ íŠ¸ë¦¬ êµ¬ì¡° í˜•ì‹ìœ¼ë¡œ ì €ìž¥í•˜ê³  ìžˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ëª¨ë“ˆ í•´**ì„ ê³¼ì •ì´ ìƒë‹¹ížˆ ë¹¨ë¼ì ¸ íš¨ìœ¨ì ì¸ ëª¨ë“ˆí•´ì„**ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

## ì ìš© (Migration)

```
rm -rf node_moduels yarn.lock
```

```
yarn set version berry

yarn ë˜ëŠ” yarn install

yarn -v
```

`yarn berry`ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì´í›„ `.pnp.cjs`ì™€ `.pnp.loader.js`, `yarnrc.yml` íŒŒì¼ê³¼ `.yarn`íŒŒì¼ì´ ìƒì„±ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

## .gitignore ì¶”ê°€

### Zero Install

**ìºì‹œëœ ì¢…ì†ì„± íŒŒì¼ì„ GitHubì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.**

```
# zero install

.yarn/\*
!.yarn/cache
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/sdks
!.yarn/versions
```

### Non Zero Install

```
#Non Zero-Installs
.pnp._
.yarn/_
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/sdks
!.yarn/versions
```

## Typescript ì ìš©

`(vscode) vscode - zipfs`í™•ìž¥í”„ë¡œê·¸ëž¨ ë‹¤ìš´

**Eslintì™€ Typescript sdk ì„¤ì¹˜**

```jsx
$ yarn dlx @yarnpkg/sdks vscode
```

## Docker file

ì•„ëž˜ëŠ” `yarn berry`ë¥¼ í™œìš©í•´ ìµœì í™”ëœ ë„ì»¤íŒŒì¼ì„ ìž‘ì„±í•œ ê²ƒìž…ë‹ˆë‹¤.

**RUN echo 'enableGlobalCache: false' >> .yarnrc.yml** ë¶€ë¶„ì—ì„œ build ì´í›„ ì„¤ì •í•©ë‹ˆë‹¤.
ì´ìœ ëŠ” ë‘ê°€ì§€ë¡œ ìƒê°í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

1.  yarn berryëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **`enableGlobalCache`ê°€ trueì´ê¸° ë•Œë¬¸ì¸ë°ìš”, ê·¸ëŸ¼ íŠ¹ì • í”„ë¡œì íŠ¸ì— ëŒ€í•´ íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ (global)ì»´í“¨í„° ì‹œìŠ¤í…œ ìžì²´ì— íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ ë˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ìž…ë‹ˆë‹¤.**
    ê·¸ëŸ¼ í•´ë‹¹ í”„ë¡œì íŠ¸ `.yarn`ì— cacheí´ë”ê°€ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ docker buildí•˜ì—¬ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ë•ŒëŠ” cacheíŒŒì¼(íŒ¨í‚¤ì§€)ì´ ìžˆì–´ì•¼ í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
2.  **build ì´í›„ `enableGlobalCache`ê°€ false**ë¡œ í•˜ëŠ” ì´ìœ ëŠ” ë§Œì•½ **build ì „ì— falseë¡œ í•˜ê²Œ ëœë‹¤ë©´** `yarn berry`ëŠ” **devdependencyê¹Œì§€ ëª¨ë‘ ìºì‹œ**í•˜ì—¬ ì €ìž¥í•˜ê¸° ë•Œë¬¸ì— ë¶ˆí•„ìš”í•œ ë°ì´í„°ê¹Œì§€ í¬í•¨ë˜ì–´ ìš©ëŸ‰ì´ ì»¤ì§€ê²Œ ë˜ê¸° ë•Œë¬¸ìž…ë‹ˆë‹¤.
    ë”°ë¼ì„œ ë¹Œë“œ ì´í›„ productionì— í•„ìš”í•œ ë¶€ë¶„ë§Œ `.zip`íŒŒì¼ì„ ìƒì„±í•˜ê¸° ìœ„í•´ **build ì´í›„ `enableGlobalCache`ê°€ false**ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤.

```jsx
FROM node:20-alpine AS base

# Install dependencies only when needed
FROM base AS deps
RUN apk update && apk add --no-cache libc6-compat vim bash

FROM deps AS builder
WORKDIR /usr/src/app
RUN yarn set version berry
RUN echo 'nodeLinker: pnp' >> .yarnrc.yml

COPY . .

# gloabl package install, build
RUN yarn
RUN yarn build
RUN yarn build-storybook

# local production package install
RUN echo 'enableGlobalCache: false' >> .yarnrc.yml
RUN yarn workspaces focus --production

FROM base AS runner
WORKDIR /usr/src/app

ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# next build file copy
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/public ./public
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/.next/static ./.next/static

# yarn pnp file copy
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/.yarn ./.yarn
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/.pnp* ./
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/yarn.lock ./
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/.yarnrc.yml ./

USER nextjs

# storybook
COPY --from=builder /usr/src/app/storybook-static ./public/storybook

EXPOSE 3000
ENV PORT 3000

CMD ["yarn", "node", "server.js"]
```
